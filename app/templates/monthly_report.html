{% extends "base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}


{% block app_content %} 
    <!-- <div class='col-md-2'></div>              -->
    <div class='col-md-12'>                      
        <h1>Create Monthly Report {{erp}}</h1> 
       
        {{  wtf.quick_form(form, button_map={'submit': 'primary','submit_delete':'danger'})}} 
        
    </div> 
    <!-- <div class='col-md-2'> </div>     -->
{% endblock %}

{% block form_scripts %}
<script type="text/javascript">
    const search_field = document.getElementById('search')    
    const values = document.querySelectorAll('option')
    const contracts = document.getElementById('contracts')
    const invoicing_group = document.getElementById('invoicing_group')
    const start_date = document.getElementById('start_datepicker');
    const end_date = document.getElementById('end_datepicker');

    init()

    contracts.onclick = () =>{
        if(document.getElementById('msg_close') !== null){
            document.getElementById('msg_close').click(); 
        }   
    }

    function init(){
        
        if(search_field.value !== '' && search_field.value !== 'none'){
            searching()
        } 
        else{
            search_field.value = ''
        }
        invoicing_group.style = 'display:none' 
           
    }
    search_field.onkeyup = () => searching()
    
    contracts.ondblclick = () =>{        
        invoicing_group.style = 'block'       
    }

    search_field.onclick = () =>{
        if(document.getElementById('msg_close') !== null){
            document.getElementById('msg_close').click(); 
        } 
    }

    function searching(){
        
        let counter = 0;
        const key_word = search_field.value.toLowerCase()
        const form_date = new Date(start_date.value)
              
        values.forEach(value => {
            const tokens = value.firstChild.textContent.split(' - ')
            let curr_end_date = new Date(tokens[tokens.length - 1])
            let curr_start_date = new Date(tokens[tokens.length - 2])
            counter++;
            if(!value.firstChild.textContent.toLowerCase().includes(key_word) ||
                (curr_end_date < form_date || curr_start_date >  form_date)){
                value.style = 'display:none'
                counter--;
                
            }else{
                value.style = 'block'                
            }
        });
        if(counter === 0){
            contracts.value = ''
        }
        if(counter >15){
            counter = 15;
        }   
        contracts.size = counter;
        initBackground()
        // console.log(contracts.size)
        // console.log(key_word)
        // console.log(counter)
    };


</script>
{% endblock %}